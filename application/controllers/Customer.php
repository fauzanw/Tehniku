<?php
defined('BASEPATH') OR exit('No direct script access allowed');

class Customer extends CI_Controller {

	/**
	*	 Generated by Generator
	**/

	public function index()
	{
		checkAuthUser('Customer');
		$perusahaan = $this->db->get_where('customer', ["user_id" => $this->session->userdata('id')])->row_array();
		$data = [
			'title'             => 'Dashboard',
			'title_main_header' => 'Dashboard',
			'data_customer'   => $perusahaan,
			'data_customer2'  => $this->session->userdata()
		];
		$this->load->view('customer/header', $data);
		$this->load->view('customer/navigator', $data);
		$this->load->view('customer/main_header', $data);
		$this->load->view('customer/index', $data);
		$this->load->view('customer/footer', $data);
	}

	public function pakejasa()
	{
		checkAuthUser('Customer');
		// echo "<pre>";print_r($data['data_jasa']); die;
		if(isset($_POST['cari_jasa'])) {
			// [$jasa, $latlon] = $_POST;
			list('type_jasa' => $type_jasa, 'keyword_jasa' => $keyword_jasa, 'latlon' => $latlon) = $_POST;
			// echo "<pre>";print_r($_POST); die;
			if($latlon) {
				$this->db
					 ->select('*')
					 ->from('jasa_pivot_type jpt')
					 ->join('jasa j', 'jpt.jasa_id=j.id')
					 ->join('jasa_type jt', 'jpt.jasa_type_id=jt.id')
					 ->join('perusahaan p', 'j.perusahaan_id=p.id')
					 ->join('jasa_keyword jk', 'j.jasa_keyword_id=jk.id');
				if($type_jasa != 'semua_jasa' && $keyword_jasa != 'semua_jasa') {
					$this->db->where('jt.id', $type_jasa);
					$this->db->where('jk.id', $keyword_jasa);
				}else if($type_jasa != 'semua_jasa' && $keyword_jasa == 'semua_jasa') {
					$this->db->where('jt.id', $type_jasa);
				}else if($type_jasa == 'semua_jasa' && $keyword_jasa != 'semua_jasa') {
					$this->db->where('jk.id', $keyword_jasa);
				}
				$data_jasa = $this->db->get()->result_array();
				foreach($data_jasa as $i => $_DATA_JASA) {
					$latlon_perusahaan = explode(", ", $_DATA_JASA['latlon']);
					$latlon_customer   = explode(", ", $latlon);
					$data_jasa[$i]['jarak'] = hitungJarak($latlon_perusahaan[0], $latlon_perusahaan[1],$latlon_customer[0], $latlon_customer[1]);
				}
				sort($data_jasa);
				// echo "<pre>";print_r($data_jasa); die;
				$customer = $this->db->get_where('customer', ["user_id" => $this->session->userdata('id')])->row_array();
				$data = [
					'title'             => 'Pake Jasa',
					'title_main_header' => 'Pake Jasa',
					'data_customer'     => $customer,
					'data_customer2'    => $this->session->userdata(),
					'data_jasa'         => $data_jasa,
					'data_type_jasa'    => $this->db->get('jasa_type')->result_array(),
					'data_keyword_jasa' => $this->db->get('jasa_keyword')->result_array()
				];
			}else{
				$this->db
					 ->select('j.*, 
								jpt.jasa_id, 
								jpt.jasa_type_id, 
								jt.type, 
								p.nama,
								p.nomor_ponsel,
								p.nomor_npwp,
								p.user_id,
								p.logo_perusahaan,
								p.latlon,
								jk.keyword
					')
					 ->from('jasa_pivot_type jpt')
					 ->join('jasa j', 'jpt.jasa_id=j.id')
					 ->join('jasa_type jt', 'jpt.jasa_type_id=jt.id')
					 ->join('perusahaan p', 'j.perusahaan_id=p.id')
					 ->join('jasa_keyword jk', 'j.jasa_keyword_id=jk.id');
				if($type_jasa != 'semua_jasa' && $keyword_jasa != 'semua_jasa') {
					$this->db->where('jt.id', $type_jasa);
					$this->db->where('jk.id', $keyword_jasa);
				}else if($type_jasa != 'semua_jasa' && $keyword_jasa == 'semua_jasa') {
					$this->db->where('jt.id', $type_jasa);
				}else if($type_jasa == 'semua_jasa' && $keyword_jasa != 'semua_jasa') {
					$this->db->where('jk.id', $keyword_jasa);
				}
				$data_jasa = $this->db->get()->result_array();
				sort($data_jasa);
				// echo "<pre>";print_r($data_jasa); die;
				$customer = $this->db->get_where('customer', ["user_id" => $this->session->userdata('id')])->row_array();
				$data = [
					'title'             => 'Pake Jasa',
					'title_main_header' => 'Pake Jasa',
					'data_customer'     => $customer,
					'data_customer2'    => $this->session->userdata(),
					'data_jasa'         => $data_jasa,
					'data_type_jasa'    => $this->db->get('jasa_type')->result_array(),
					'data_keyword_jasa' => $this->db->get('jasa_keyword')->result_array()
				];
				foreach($data['data_jasa'] as $i => $_DATA_JASA) {
					$latlon_perusahaan = explode(", ", $_DATA_JASA['latlon']);
					$latlon_customer   = explode(", ", $customer['latlon']);
					$data['data_jasa'][$i]['jarak'] = hitungJarak($latlon_perusahaan[0], $latlon_perusahaan[1],$latlon_customer[0], $latlon_customer[1]);
				}
			}
		}else{
			$customer = $this->db->get_where('customer', ["user_id" => $this->session->userdata('id')])->row_array();
			$data = [
				'title'             => 'Pake Jasa',
				'title_main_header' => 'Pake Jasa',
				'data_customer'     => $customer,
				'data_customer2'    => $this->session->userdata(),
				'data_jasa'         => $this->db->select('j.*, jpt.jasa_id, jpt.jasa_type_id, jt.type, p.nama,p.nomor_ponsel,p.nomor_npwp,p.user_id,p.logo_perusahaan,p.latlon,jk.keyword')->from('jasa_pivot_type jpt')->join('jasa j', 'jpt.jasa_id=j.id')->join('jasa_type jt', 'jpt.jasa_type_id=jt.id')->join('perusahaan p', 'j.perusahaan_id=p.id')->join('jasa_keyword jk', 'j.jasa_keyword_id=jk.id')->get()->result_array(),
				'data_type_jasa'    => $this->db->get('jasa_type')->result_array(),
				'data_keyword_jasa' => $this->db->get('jasa_keyword')->result_array()
			];
			foreach($data['data_jasa'] as $i => $_DATA_JASA) {
				$latlon_perusahaan = explode(", ", $_DATA_JASA['latlon']);
				$latlon_customer   = explode(", ", $customer['latlon']);
				$data['data_jasa'][$i]['jarak'] = hitungJarak($latlon_perusahaan[0], $latlon_perusahaan[1],$latlon_customer[0], $latlon_customer[1]);
			}
		}
		$this->load->view('customer/header', $data);
		$this->load->view('customer/navigator', $data);
		$this->load->view('customer/main_header', $data);
		$this->load->view('customer/pakejasa', $data);
		$this->load->view('customer/footer', $data);
	}

	public function process_pakejasa($jasa_id) {
		$customer = $this->db->get_where('customer', ["user_id" => $this->session->userdata('id')])->row_array();
		$this->db
			 ->select('*')
			 ->from('jasa_pivot_type jpt')
			 ->join('jasa j', 'jpt.jasa_id=j.id')
			 ->join('jasa_type jt', 'jpt.jasa_type_id=jt.id')
			 ->join('perusahaan p', 'j.perusahaan_id=p.id')
			 ->join('jasa_keyword jk', 'j.jasa_keyword_id=jk.id')
			 ->where('j.id', $jasa_id);
		$cekjasa = $this->db->get()->row_array();
		$cektype = $this->db->get_where('jasa_type', ['id' => $_GET['type']])->row_array();
		$latlon_perusahaan = explode(", ", $cekjasa['latlon']);
		// $latlon_customer   = explode(", ", );
		// $jarak = openssl_decrypt($_GET['coor'], 'AES-128-CBC', 'T3hn1ku', OPENSSL_RAW_DATA, openssl_random_pseudo_bytes(16));
		// var_dump(base64_decode($_GET['coor'])); die;
		// $jarak = hitungJarak($latlon_perusahaan[0], $latlon_perusahaan[1],$latlon_customer[0], $latlon_customer[1]);
		$data = [
			'title'             => 'Setting',
			'title_main_header' => 'Setting',
			'data_customer'     => $customer,
			'data_customer2'    => $this->session->userdata(),
			'data_jasa'         => $cekjasa,
		];
		if(isset($_GET['type']) && isset($_GET['coor'])) {
			if(!$cekjasa) {
				show_404();
			}else if(!$cektype) {
				show_404();	
			}else{
				$this->load->view('customer/header', $data);
				$this->load->view('customer/navigator', $data);
				$this->load->view('customer/main_header', $data);
				$this->load->view('customer/process_pakejasa', $data);
				$this->load->view('customer/footer', $data);
			}
		}else{
			show_404();
		}
	}

	public function setting() 
	{
		checkAuthUser('Customer');
		$customer = $this->db->get_where('customer', ["user_id" => $this->session->userdata('id')])->row_array();
		$data = [
			'title'             => 'Setting',
			'title_main_header' => 'Setting',
			'data_customer'     => $customer,
			'data_customer2'    => $this->session->userdata(),
		];
		if(!isset($_POST['edit_data'])) {
			$this->load->view('customer/header', $data);
			$this->load->view('customer/navigator', $data);
			$this->load->view('customer/main_header', $data);
			$this->load->view('customer/setting', $data);
			$this->load->view('customer/footer', $data);
		}else{
			$email           = $this->input->post('email');
			$edited_password = $this->input->post('password');
			$new_password    = password_hash($edited_password, PASSWORD_DEFAULT);
			$old_password    = $this->input->post('password_lama');
			// jika password mau diubah
			if($edited_password) {
				if(!$old_password) {
					$this->session->set_flashdata('message', '<div class="alert alert-danger alert-dismissible fade show" role="alert"><strong>Gagal</strong> ganti password, password lama tidak boleh kosong.<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>');
					redirect('perusahaan');
				}else if(password_verify($old_password, $data['data_customer2']['password'])) {
					$this->db->set('password', $new_password);
				}
			}
			$this->db->set('email', $email);
			$this->db->where('id', $data['data_customer2']['id']);
			$up = $this->db->update('users');

			$this->session->set_userdata('email', $email);
			$this->session->set_userdata('password', $new_password);

			$this->session->set_flashdata('message', '<div class="alert alert-success alert-dismissible fade show" role="alert"><strong>Akun Customer</strong> berhasil di ubah.<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>');
			redirect('customer');
		}
	}

}

?>