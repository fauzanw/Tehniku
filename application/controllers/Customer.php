<?php
defined('BASEPATH') OR exit('No direct script access allowed');

class Customer extends CI_Controller {

	/**
	*	 Generated by Generator
	**/

	public function __construct(){
		parent::__construct();
		checkAuthUser('Customer');
	}

	public function index()
	{
		$customer = $this->db->get_where('customer', ["user_id" => $this->session->userdata('id')])->row_array();
		$data = [
			'title'                   => 'Dashboard',
			'title_main_header'       => 'Dashboard',
			'data_customer'           => $customer,
			'data_customer2'          => $this->session->userdata(),
			'jumlah_pesanan_saat_ini' => sizeof($this->db->get_where('pesanan', ['customer_id' => $customer['id'], 'status !=' => 4])->result_array()),
			'jumlah_semua_pesanan'    => sizeof($this->db->get_where('pesanan', ['customer_id' => $customer['id']])->result_array())
		];
		$this->load->view('customer/header', $data);
		$this->load->view('customer/navigator', $data);
		$this->load->view('customer/main_header', $data);
		$this->load->view('customer/index', $data);
		$this->load->view('customer/footer', $data);
	}

	public function pakejasa()
	{
		// echo "<pre>";print_r($data['data_jasa']); die;
		if(isset($_POST['cari_jasa'])) {
			// [$jasa, $latlon] = $_POST;
			list('type_jasa' => $type_jasa, 'keyword_jasa' => $keyword_jasa, 'latlon' => $latlon) = $_POST;
			// echo "<pre>";print_r($_POST); die;
			if($latlon) {
				$this->db
					 ->select('*')
					 ->from('jasa_pivot_type jpt')
					 ->join('jasa j', 'jpt.jasa_id=j.id')
					 ->join('jasa_type jt', 'jpt.jasa_type_id=jt.id')
					 ->join('perusahaan p', 'j.perusahaan_id=p.id')
					 ->join('jasa_keyword jk', 'j.jasa_keyword_id=jk.id');
				if($type_jasa != 'semua_jasa' && $keyword_jasa != 'semua_jasa') {
					$this->db->where('jt.id', $type_jasa);
					$this->db->where('jk.id', $keyword_jasa);
				}else if($type_jasa != 'semua_jasa' && $keyword_jasa == 'semua_jasa') {
					$this->db->where('jt.id', $type_jasa);
				}else if($type_jasa == 'semua_jasa' && $keyword_jasa != 'semua_jasa') {
					$this->db->where('jk.id', $keyword_jasa);
				}
				$data_jasa = $this->db->get()->result_array();
				foreach($data_jasa as $i => $_DATA_JASA) {
					$latlon_perusahaan = explode(", ", $_DATA_JASA['latlon']);
					$latlon_customer   = explode(", ", $latlon);
					if(isset($latlon_perusahaan[0]) && isset($latlon_perusahaan[1]) && isset($latlon_customer[0]) && isset($latlon_customer[1])) {
						$jarak             = hitungJarak($latlon_perusahaan[0], $latlon_perusahaan[1],$latlon_customer[0], $latlon_customer[1]);
					}else{
						$jarak             = "Latitude & Longitude tidak valid";
					}
					if($jarak) {
						$data_jasa[$i]['jarak'] = $jarak;
					}
				}
				sort($data_jasa);
				// echo "<pre>";print_r($data_jasa); die;
				$customer = $this->db->get_where('customer', ["user_id" => $this->session->userdata('id')])->row_array();
				$data = [
					'title'                   => 'Pake Jasa',
					'title_main_header'       => 'Pake Jasa',
					'data_customer'           => $customer,
					'data_customer2'          => $this->session->userdata(),
					'data_jasa'               => $data_jasa,
					'data_type_jasa'          => $this->db->get('jasa_type')->result_array(),
					'data_keyword_jasa'       => $this->db->get('jasa_keyword')->result_array(),
					'jumlah_pesanan_saat_ini' => sizeof($this->db->get_where('pesanan', ['customer_id' => $customer['id'], 'status !=' => 4])->result_array()),
					'jumlah_semua_pesanan'    => sizeof($this->db->get_where('pesanan', ['customer_id' => $customer['id']])->result_array())
				];
			}else{
				$this->db
					 ->select('j.*, 
								jpt.jasa_id, 
								jpt.jasa_type_id, 
								jt.type, 
								p.nama,
								p.nomor_ponsel,
								p.nomor_npwp,
								p.user_id,
								p.logo_perusahaan,
								p.latlon,
								jk.keyword
					')
					 ->from('jasa_pivot_type jpt')
					 ->join('jasa j', 'jpt.jasa_id=j.id')
					 ->join('jasa_type jt', 'jpt.jasa_type_id=jt.id')
					 ->join('perusahaan p', 'j.perusahaan_id=p.id')
					 ->join('jasa_keyword jk', 'j.jasa_keyword_id=jk.id');
				if($type_jasa != 'semua_jasa' && $keyword_jasa != 'semua_jasa') {
					$this->db->where('jt.id', $type_jasa);
					$this->db->where('jk.id', $keyword_jasa);
				}else if($type_jasa != 'semua_jasa' && $keyword_jasa == 'semua_jasa') {
					$this->db->where('jt.id', $type_jasa);
				}else if($type_jasa == 'semua_jasa' && $keyword_jasa != 'semua_jasa') {
					$this->db->where('jk.id', $keyword_jasa);
				}
				$data_jasa = $this->db->get()->result_array();
				sort($data_jasa);
				// echo "<pre>";print_r($data_jasa); die;
				$customer = $this->db->get_where('customer', ["user_id" => $this->session->userdata('id')])->row_array();
				$data = [
					'title'                   => 'Pake Jasa',
					'title_main_header'       => 'Pake Jasa',
					'data_customer'           => $customer,
					'data_customer2'          => $this->session->userdata(),
					'data_jasa'               => $data_jasa,
					'data_type_jasa'          => $this->db->get('jasa_type')->result_array(),
					'data_keyword_jasa'       => $this->db->get('jasa_keyword')->result_array(),
					'jumlah_pesanan_saat_ini' => sizeof($this->db->get_where('pesanan', ['customer_id' => $customer['id'], 'status !=' => 4])->result_array()),
					'jumlah_semua_pesanan'    => sizeof($this->db->get_where('pesanan', ['customer_id' => $customer['id']])->result_array())
				];
				foreach($data['data_jasa'] as $i => $_DATA_JASA) {
					$latlon_perusahaan = explode(", ", $_DATA_JASA['latlon']);
					$latlon_customer   = explode(", ", $customer['latlon']);
					if(isset($latlon_perusahaan[0]) && isset($latlon_perusahaan[1]) && isset($latlon_customer[0]) && isset($latlon_customer[1])) {
						$jarak             = hitungJarak($latlon_perusahaan[0], $latlon_perusahaan[1],$latlon_customer[0], $latlon_customer[1]);
					}else{
						$jarak             = "Latitude & Longitude tidak valid";
					}
					if($jarak) {
						$data['data_jasa'][$i]['jarak'] = $jarak;
					}
				}
			}
		}else{
			$customer = $this->db->get_where('customer', ["user_id" => $this->session->userdata('id')])->row_array();
			$data = [
				'title'                   => 'Pake Jasa',
				'title_main_header'       => 'Pake Jasa',
				'data_customer'           => $customer,
				'data_customer2'          => $this->session->userdata(),
				'data_jasa'               => $this->db->select('j.*, jpt.jasa_id, jpt.jasa_type_id, jt.type, p.nama,p.nomor_ponsel,p.nomor_npwp,p.user_id,p.logo_perusahaan,p.latlon,jk.keyword')->from('jasa_pivot_type jpt')->join('jasa j', 'jpt.jasa_id=j.id')->join('jasa_type jt', 'jpt.jasa_type_id=jt.id')->join('perusahaan p', 'j.perusahaan_id=p.id')->join('jasa_keyword jk', 'j.jasa_keyword_id=jk.id')->get()->result_array(),
				'data_type_jasa'          => $this->db->get('jasa_type')->result_array(),
				'data_keyword_jasa'       => $this->db->get('jasa_keyword')->result_array(),
				'jumlah_pesanan_saat_ini' => sizeof($this->db->get_where('pesanan', ['customer_id' => $customer['id'], 'status !=' => 4])->result_array()),
				'jumlah_semua_pesanan'    => sizeof($this->db->get_where('pesanan', ['customer_id' => $customer['id']])->result_array())
			];
			// echo '<pre>';print_r($data['data_jasa']); die;
			foreach($data['data_jasa'] as $i => $_DATA_JASA) {
				$latlon_perusahaan = explode(", ", $_DATA_JASA['latlon']);
				$latlon_customer   = explode(", ", $customer['latlon']);
				if(isset($latlon_perusahaan[0]) && isset($latlon_perusahaan[1]) && isset($latlon_customer[0]) && isset($latlon_customer[1])) {
					$jarak             = hitungJarak($latlon_perusahaan[0], $latlon_perusahaan[1],$latlon_customer[0], $latlon_customer[1]);
				}else{
					$jarak             = "Latitude & Longitude tidak valid";
				}
				if($jarak) {
					$data['data_jasa'][$i]['jarak'] = $jarak;
				}
			}
		}
		$this->load->view('customer/header', $data);
		$this->load->view('customer/navigator', $data);
		$this->load->view('customer/main_header', $data);
		$this->load->view('customer/pakejasa', $data);
		$this->load->view('customer/footer', $data);
	}

	public function process_pakejasa($jasa_id) {
		$customer = $this->db->get_where('customer', ["user_id" => $this->session->userdata('id')])->row_array();
		$this->db
			 ->select('*')
			 ->from('jasa_pivot_type jpt')
			 ->join('jasa j', 'jpt.jasa_id=j.id')
			 ->join('jasa_type jt', 'jpt.jasa_type_id=jt.id')
			 ->join('jasa_keyword jk', 'j.jasa_keyword_id=jk.id')
			 ->join('perusahaan p', 'j.perusahaan_id=p.id')
			 ->where('j.id', $jasa_id);
		$cekjasa = $this->db->get()->row_array();
		$cektype = $this->db->get_where('jasa_type', ['id' => $_GET['type']])->row_array();
		// $latlon_customer   = explode(", ", );
		// $jarak = openssl_decrypt($_GET['coor'], 'AES-128-CBC', 'T3hn1ku', OPENSSL_RAW_DATA, openssl_random_pseudo_bytes(16));
		// var_dump(base64_decode($_GET['coor'])); die;
		// $jarak = hitungJarak($latlon_perusahaan[0], $latlon_perusahaan[1],$latlon_customer[0], $latlon_customer[1]);
		$data = [
			'title'                   => 'Proses Pakejasa',
			'title_main_header'       => 'Proses Pakejasa',
			'data_customer'           => $customer,
			'data_customer2'          => $this->session->userdata(),
			'data_jasa'               => $cekjasa,
			'data_pesanan'            => $this->db->get_where('pesanan', ['jasa_id' => $jasa_id])->row_array(),
			'jarak'                   => base64_decode($_GET['coor']),
			'jumlah_pesanan_saat_ini' => sizeof($this->db->get_where('pesanan', ['customer_id' => $customer['id'], 'status !=' => 4])->result_array()),
			'jumlah_semua_pesanan'    => sizeof($this->db->get_where('pesanan', ['customer_id' => $customer['id']])->result_array())
		];
		if(isset($_POST['set_jadwal'])) {
			if(isset($_POST['jadwal']) && isset($_POST['description'])) {
				$split_jadwal = explode(" ", $_POST['jadwal']);
				$pisah        = explode("/", $split_jadwal[1]);
				$jadwal       = formatHariTanggal("$pisah[2]-$pisah[0]-$pisah[1]") . " Jam $split_jadwal[0]";
				$data_pesanan = [
					'id'               => uniqid(),
					'jasa_id'          => $jasa_id,
					'perusahaan_id'    => $cekjasa['id'],
					'customer_id'      => $data['data_customer']['id'],
					'waktu'            => $jadwal,
					'description'      => htmlspecialchars($_POST['description']),
					'pegawai_id'       => '',	
					'material_id_used' => $data['data_pesanan']['type'] == 'instalasi' ? 'all':'',
					'status'        => 1
				];
				$this->db->insert('pesanan', $data_pesanan);
				$this->session->set_flashdata('message', '<div class="alert alert-success alert-dismissible fade show" role="alert"><strong>Berhasil</strong> pesan jasa.<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>');
				redirect('customer/pakejasa/pesanan');
			}else{
				$this->session->set_flashdata('message', '<div class="alert alert-danger alert-dismissible fade show" role="alert"><strong>Gagal</strong> pesan jasa, ada input yang tidak boleh kosong.<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>');
				redirect('customer/pakejasa/pesanan');
			}
		}else{
			if(isset($_GET['type']) && isset($_GET['coor'])) {
				$this->load->view('customer/header', $data);
				$this->load->view('customer/navigator', $data);
				$this->load->view('customer/main_header', $data);
				$this->load->view('customer/process_pakejasa', $data);
				$this->load->view('customer/footer', $data);
			}else{
				show_404();
			}
		}
	}

	public function pesanan_pakejasa()
	{
		$customer = $this->db->get_where('customer', ["user_id" => $this->session->userdata('id')])->row_array();
		$pesanan = $this->db->get_where('pesanan', ['customer_id' => $customer['id']])->result_array();
		$data_jasa = [];
		foreach($pesanan as $data) {
			$this->db
				 ->select('*')
				 ->from('jasa_pivot_type jpt')
				 ->join('jasa j', 'jpt.jasa_id=j.id')
				 ->join('jasa_type jt', 'jpt.jasa_type_id=jt.id')
				 ->join('perusahaan p', 'j.perusahaan_id=p.id')
				 ->join('jasa_keyword jk', 'j.jasa_keyword_id=jk.id')
				 ->where('jpt.jasa_id', $data['jasa_id']);
			array_push($data_jasa, $this->db->get()->row_array());	
		}
		foreach($data_jasa as $i => $data) {
			$latlon_customer   = explode(", ", $customer['latlon']);
			$latlon_perusahaan = explode(", ", $data['latlon']);
			if(isset($latlon_perusahaan[0]) && isset($latlon_perusahaan[1]) && isset($latlon_customer[0]) && isset($latlon_customer[1])) {
				$jarak             = hitungJarak($latlon_perusahaan[0], $latlon_perusahaan[1],$latlon_customer[0], $latlon_customer[1]);
			}else{
				$jarak             = "Latitude & Longitude tidak valid";
			}
			if($jarak) {
				$data_jasa[$i]['jarak'] = $jarak;
			}
		}
		// echo "<pre>";print_r([$data_jasa, $pesanan]); die;
		$data = [
			'title'                   => 'Pesanan',
			'title_main_header'       => 'Pesanan',
			'data_customer'           => $customer,
			'data_customer2'          => $this->session->userdata(),
			'data_pesanan'            => $pesanan,
			'data_jasa'               => $data_jasa,
			'jumlah_pesanan_saat_ini' => sizeof($this->db->get_where('pesanan', ['customer_id' => $customer['id'], 'status !=' => 4])->result_array()),
			'jumlah_semua_pesanan'    => sizeof($this->db->get_where('pesanan', ['customer_id' => $customer['id']])->result_array())
		];
		$this->load->view('customer/header', $data);
		$this->load->view('customer/navigator', $data);
		$this->load->view('customer/main_header', $data);
		$this->load->view('customer/pesanan', $data);
		$this->load->view('customer/footer', $data);
	}

	public function pesanan_detail_pakejasa($id_pesanan)
	{
		$customer = $this->db->get_where('customer', ["user_id" => $this->session->userdata('id')])->row_array();
		$this->db
			 ->select('*')
			 ->from('pesanan ps')
			 ->join('customer c', 'ps.customer_id=c.id')
			 ->join('perusahaan p', 'ps.perusahaan_id=p.id')
			 ->where('ps.id', $id_pesanan);
		$pesanan = $this->db->get()->row_array();
		$this->db
			 ->select('*')
			 ->from('jasa_pivot_type jpt')
			 ->join('jasa j', 'jpt.jasa_id=j.id')
			 ->join('jasa_type jt', 'jpt.jasa_type_id=jt.id')
			 ->join('jasa_keyword jk', 'j.jasa_keyword_id=jk.id')
			 ->where('jpt.jasa_id', $pesanan['jasa_id']);
		$data_jasa = $this->db->get()->row_array();
		$data_pegawai_to_surveying = [];
		if(preg_match("/,/",$pesanan['pegawai_id'])) {
			$pegawai_id = explode(",", $pesanan['pegawai_id']);
			foreach($pegawai_id as $id_pegawai) {
				array_push($data_pegawai_to_surveying, $this->db->get_where('pegawai', ['id' => $id_pegawai])->row_array());
			}
		}else{
			array_push($data_pegawai_to_surveying, $this->db->get_where('pegawai', ['id' => $pesanan['pegawai_id']])->row_array());
		}

		$data_material_used = [];
		$data_material = $this->db->select('m.*,mk.nama_merek')->from('material m')->join('merek mk', 'm.merek_id=mk.id')->where('jasa_keyword_id', $data_jasa['jasa_keyword_id'])->get()->result_array();
		if($pesanan['material_id_used'] == 'all') {
			$this->db
				 ->select('*')
				 ->from('material m')
				 ->join('merek mk', 'm.merek_id=mk.id')
				 ->where('m.jasa_keyword_id', $data_jasa['jasa_keyword_id']);
			array_push($data_material_used, $this->db->get()->result_array())[0];
		}else if(preg_match("/,/", $pesanan['material_id_used'])){
			$material_id_used = explode(",", $pesanan['material_id_used']);
			foreach($material_id_used as $material_id) {
				$this->db
					 ->select('*')
					 ->from('material m')
					 ->join('merek mk', 'm.merek_id=mk.id')
					 ->where('m.id', $material_id)
					 ->where('m.jasa_keyword_id', $data_jasa['jasa_keyword_id']);
				 array_push($data_material_used, $this->db->get()->row_array());
			}
		}

		$data_harga_material_array = [];
		$data_harga_jasa           = join("", explode(".", explode("Rp. ", $data_jasa['harga'])[1]));
		foreach($data_material_used as $data) {
			$data_harga_material_array[] = join("", explode(".", $data['harga']));
		}
		$data_harga_material       = array_sum($data_harga_material_array);
		$data_total                = array_sum([$data_harga_material, $data_harga_jasa]);

		if($pesanan && $data_jasa) {
			$latlon_customer   = explode(", ", $customer['latlon']);
			$latlon_perusahaan = explode(", ", $pesanan['latlon']);
			if(isset($latlon_perusahaan[0]) && isset($latlon_perusahaan[1]) && isset($latlon_customer[0]) && isset($latlon_customer[1])) {
				$jarak             = hitungJarak($latlon_perusahaan[0], $latlon_perusahaan[1],$latlon_customer[0], $latlon_customer[1]);
			}else{
				$jarak             = "Latitude & Longitude tidak valid";
			}
			if($jarak) {
				$data_jasa['jarak'] = $jarak;
			}
			$data = [
				'title'                   => 'Detail Pesanan Pakejasa',
				'title_main_header'       => 'Detail Pesanan Pakejasa',
				'data_customer'           => $customer,
				'data_customer2'          => $this->session->userdata(),
				'data_pesanan'            => $pesanan,
				'data_jasa'               => $data_jasa,
				'data_pegawai_to_survey'  => $data_pegawai_to_surveying,
				'data_material_used'      => $data_material_used,
				'data_harga_total'        => formatRupiah($data_total),
				'jumlah_pesanan_saat_ini' => sizeof($this->db->get_where('pesanan', ['customer_id' => $customer['id'], 'status !=' => 4])->result_array()),
				'jumlah_semua_pesanan'     => sizeof($this->db->get_where('pesanan', ['customer_id' => $customer['id']])->result_array())
			];
			if($pesanan['status'] == 1) {
				if(!isset($_POST['ubah_data'])) {
					$this->load->view('customer/header', $data);
					$this->load->view('customer/navigator', $data);
					$this->load->view('customer/main_header', $data);
					$this->load->view('customer/wait_verified_pesanan', $data);
					$this->load->view('customer/footer', $data);
				}else{
					if($_POST['description']) {
						$this->db->set('description', $_POST['description']);
					}

					if($_POST['jadwal']) {
						$split_jadwal = explode(" ", $_POST['jadwal']);
						$pisah        = explode("/", $split_jadwal[1]);
						$jadwal       = formatHariTanggal("$pisah[2]-$pisah[0]-$pisah[1]") . " Jam $split_jadwal[0]";
						$this->db->set('waktu', $jadwal);
					}

					$this->db->where('id', $id_pesanan);
					$this->db->update('pesanan');
					$this->session->set_flashdata('message', '<div class="alert alert-success alert-dismissible fade show" role="alert"><strong>Berhasil</strong> ubah data pesanan.<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>');
					redirect("customer/pakejasa/pesanan/$id_pesanan/detail");
				}
			}else if($pesanan['status'] == 2) {
				$this->load->view('customer/header', $data);
				$this->load->view('customer/navigator', $data);
				$this->load->view('customer/main_header', $data);
				$this->load->view('customer/verified_pesanan', $data);
				$this->load->view('customer/footer', $data);
			}else if($pesanan['status'] == 3){
				$this->load->view('customer/header', $data);
				$this->load->view('customer/navigator', $data);
				$this->load->view('customer/main_header', $data);
				$this->load->view('customer/surveying_pesanan', $data);
				$this->load->view('customer/footer', $data);
			}else if($pesanan['status'] == 4) {
				$this->load->view('customer/header', $data);
				$this->load->view('customer/navigator', $data);
				$this->load->view('customer/main_header', $data);
				$this->load->view('customer/selesai_pesanan', $data);
				$this->load->view('customer/footer', $data);
			}
		}else{
			show_error("Data pesanan tidak valid", 400);
		}
	}

	public function setting() 
	{
		$customer = $this->db->get_where('customer', ["user_id" => $this->session->userdata('id')])->row_array();
		$data = [
			'title'                   => 'Setting',
			'title_main_header'       => 'Setting',
			'data_customer'           => $customer,
			'data_customer2'          => $this->session->userdata(),
			'jumlah_pesanan_saat_ini' => sizeof($this->db->get_where('pesanan', ['customer_id' => $customer['id'], 'status !=' => 4])->result_array()),
			'jumlah_semua_pesanan'    => sizeof($this->db->get_where('pesanan', ['customer_id' => $customer['id']])->result_array())
		];
		if(!isset($_POST['edit_data'])) {
			$this->load->view('customer/header', $data);
			$this->load->view('customer/navigator', $data);
			$this->load->view('customer/main_header', $data);
			$this->load->view('customer/setting', $data);
			$this->load->view('customer/footer', $data);
		}else{
			list('nama' => $nama, 'email' => $email, 'new_password' => $edited_password, 'old_password' => $old_password, 'nomor_ponsel' => $nomor_ponsel, 'alamat' => $alamat) = $_POST;
			$new_password    = password_hash($edited_password, PASSWORD_DEFAULT);
			$data_customer   = $this->db->get_where('users', ['id' => $this->session->userdata('id')])->row_array();
			$cek_email       = $this->db->select('*')->from('users')->where_not_in('email', $data['data_customer2']['email'])->where('email', $email)->get()->row_array();

			if($cek_email) {
				$this->session->set_flashdata('message', '<div class="alert alert-danger alert-dismissible fade show" role="alert"><strong>Gagal</strong> edit email, email yang anda masukkan sudah digunakan.<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>');
				redirect('customer');
			}
			$edited_foto     = $_FILES['foto_customer']['name'];
			// jika password mau diubah
			if($edited_password) {
				if(!$old_password) {
					$this->session->set_flashdata('message', '<div class="alert alert-danger alert-dismissible fade show" role="alert"><strong>Gagal</strong> ganti password, password lama tidak boleh kosong.<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>');
					redirect('customer');
				}else {
					if(password_verify($old_password, $data_customer['password'])) {
						$this->db->set('password', $new_password);
					}else{
						// echo $old_password."<br><br>",
						// $data['data_customer2']['password']."<br><br>";
						// echo password_verify($old_password, $data['data_customer2']['password']); die;
						$this->session->set_flashdata('message', '<div class="alert alert-danger alert-dismissible fade show" role="alert"><strong>Gagal</strong> ganti password, password lama salah.<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>');
						redirect('customer');
					}
				}
			}
			$this->db->set('email', $email);
			$this->db->where('id', $data['data_customer2']['id']);
			$this->db->update('users');

			if($edited_foto) {
				$config = array(
					'allowed_types' => 'jpeg|jpg|png',
					'max_size'      => '2048',
					'upload_path'   => './assets/argon/img/customer/',
					'encrypt_name'  => TRUE
				);
				$this->load->library('upload', $config);

				if($this->upload->do_upload('foto_customer')) {
					$new_logo = $this->upload->data('file_name');
					if($data['data_customer']['foto_customer'] != 'default.png') {
						unlink(FCPATH."assets/argon/img/customer/".$data['data_customer']['foto_customer']);
					}
					$this->db->set('foto_customer', $new_logo);
				}else{
					if($this->upload->display_errors() == "<p>The filetype you are attempting to upload is not allowed.</p>") {
						$this->session->set_flashdata('message', '<div class="alert alert-danger alert-dismissible fade show" role="alert"><strong>Gagal</strong> edit foto, format foto harus jpg / png /jpeg.<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>');
						redirect('customer');
					} else if($this->upload->display_errors() == "<p>The file you are attempting to upload is larger than the permitted size.</p>") {
						$this->session->set_flashdata('message', '<div class="alert alert-danger alert-dismissible fade show" role="alert"><strong>Gagal</strong> edit foto, size foto tidak boleh lebih dari 2mb.<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>');
						redirect('customer');
					} else {
						echo $this->upload->display_errors();die;	
					}
				}
			} 
			$this->db->set('nama', $nama);
			$this->db->set('nomor_ponsel', $nomor_ponsel);
			$this->db->set('alamat', $alamat);
			$this->db->where('user_id', $data['data_customer2']['id']);
			$this->db->update('customer');

			$this->session->set_userdata('email', $email);
			$this->session->set_userdata('password', $new_password);

			$this->session->set_flashdata('message', '<div class="alert alert-success alert-dismissible fade show" role="alert"><strong>Akun Customer</strong> berhasil di ubah.<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>');
			redirect('customer');
		}
	}

}

?>